<!-- Check https://perfetto.dev/docs/visualization/deep-linking-to-perfetto-ui for more details -->
<!doctype html>
<html lang="en-us">
<body>

<style>
pre {
  border: 1px solid red;
}

</style>

<button type="button" id="btn_fetch">Fetch and open trace</button>
<br>

<pre id="logs" cols="80" rows="20"></pre>

<script type="text/javascript">

const logs = document.getElementById("logs");
const btnFetch = document.getElementById('btn_fetch');
const ORIGIN = 'https://ui.perfetto.dev';

async function fetchAndOpen() {
  const urlParams = new URLSearchParams(window.location.search);
  const trace_url = urlParams.get('url');
  if (!trace_url) {
    logs.innerText += "Missing url argument!\n";
    return;
  } 

  logs.innerText += `Fetching trace from ${trace_url}...\n`;
  const resp = await fetch(trace_url);
  const blob = await resp.blob();
  const arrayBuffer = await blob.arrayBuffer();
  logs.innerText += `fetch() complete, now passing to ui.perfetto.dev\n`;
  openTrace(arrayBuffer, trace_url);
}

function openTrace(arrayBuffer, traceUrl) {
  const win = window.open(ORIGIN);
  if (!win) {
    logs.innerText += `Popups blocked, you need to manually click the button`;
    return;
  }
  const timer = setInterval(() => win.postMessage('PING', ORIGIN), 50);
  const onMessageHandler = (evt) => {
    if (evt.data !== 'PONG') return;

    // We got a PONG, the UI is ready.
    window.clearInterval(timer);
    window.removeEventListener('message', onMessageHandler);

    const reopenUrl = new URL(location.href);
    reopenUrl.hash = `#reopen=${traceUrl}`;
    win.postMessage({
      perfetto: {
        buffer: arrayBuffer,
        title: 'The Trace Title',
        url: reopenUrl.toString(),
    }}, ORIGIN);
    window.close(); // close self
  };

  window.addEventListener('message', onMessageHandler);
}

window.onload = function() {
  // Your code to execute when the entire page and all resources are loaded
  logs.innerText += "Window loaded\n";
  fetchAndOpen()
}

btnFetch.onclick = () => fetchAndOpen();
</script>

</body>
</html>
